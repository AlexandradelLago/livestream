<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="http://cdn.staticfile.org/jquery/2.1.1-rc2/jquery.js" ></script>
		<script type="text/javascript" src="./node_modules/webrtc-adapter-test/adapter.js" ></script>
		<script type="text/javascript" src="/socket.io/socket.io.js" ></script>
		<script type="text/javascript">
		function convertInt16ToFloat32(data) {
			var result = new Float32Array(data.length);
			data.forEach(function(sample, i) {
				result[i] = sample < 0 ? sample / 0x80 : sample / 0x7F;
			});
			return result;
		}
		
		$(function () {
			var receiving = false;
			var self = this, room = 'foo';
			var canvasContext = $('#remote')[0].getContext('2d');
			var remoteImg = $('#remoteImg')[0];
			
			window.AudioContext = window.AudioContext || window.webkitAudioContext;
			self.audioContext = new AudioContext();
			var socket = io.connect();
			socket.on('connect', function() {
				socket.emit('register', { type: "receiver" });
				socket.on('audio', function(msg) {
					if (receiving) {
						var data = new Int16Array(msg);
						data = convertInt16ToFloat32(data);
						var buffer = self.audioContext.createBuffer(1, data.length, 44100);
						var bufferSource = self.audioContext.createBufferSource();
						var gain = self.audioContext.CreateGain();
						gain.gain.value = 0.25;
						buffer.getChannelData(0).set(data);
						bufferSource.buffer = buffer;
						bufferSource.connect(gain);
						gain.connect(self.audioContext.destination); 
						bufferSource.start(0);
					}
				});
				socket.on('video', function(data) {
					if (receiving) {
						remoteImg.src = data;
//						var imageData = canvasContext.createImageData(data.width, data.height);
//						for(var i = 0; i < data.data.length; i++) imageData.data[i] = data.data[i];
//						canvasContext.putImageData(imageData, 0, 0);
					}
				});
			});
			$('#receive').click(function() {
				receiving = true;
			});
			$('#stop').click(function() {
				receiving = false;
			});
		});
		</script>
	</head>
	<body>
		<button id="receive">receive</button>
		<button id="stop">stop</button>
		<canvas id="remote" style="max-width: 320px; max-height: 240px"></canvas>
		<img id="remoteImg" style="width:320px; height:240px"></img>
	</body>
</html>
